// ============================================================================
// NOTIFICATIONS FEATURE MODULE
// Enable with: features.notifications = true
// ============================================================================

model Activity {
  id         String   @id @default(cuid())
  type       String
  targetId   String   @map("target_id")
  targetType String   @map("target_type")
  target     String
  targetLink String   @map("target_link")
  tags       String[] @default([])
  expiresAt  DateTime @default(dbgenerated("(NOW() + '1 year'::interval)")) @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  actorId    String  @map("actor_id")
  receiverId String? @map("receiver_id")
  groupId    String? @map("group_id")

  actor         User           @relation("activitiesAsActor", fields: [actorId], references: [id], onDelete: Cascade)
  receiver      User?          @relation("receiverActivities", fields: [receiverId], references: [id], onDelete: SetNull)
  notifications Notification[]

  @@index([actorId])
  @@index([receiverId])
  @@index([groupId])
  @@index([type, targetType, targetId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("activities")
}

model Notification {
  id        String   @id @default(cuid())
  isRead    Boolean  @default(false) @map("is_read")
  dismissed Boolean  @default(false)
  expiresAt DateTime @default(dbgenerated("(NOW() + '1 year'::interval)")) @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  receiverId String @map("receiver_id")
  activityId String @map("activity_id")

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  receiver User     @relation(fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([receiverId])
  @@index([activityId])
  @@index([expiresAt])
  @@index([receiverId, isRead])
  @@map("notifications")
}

model NotificationPreference {
  id       String   @id @default(cuid())
  type     String
  disabled String[] @default([])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("notification_preferences")
}
